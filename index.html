<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Free TV & Movie Tracker</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
      padding: 20px;
    }
    input {
      padding: 10px;
      width: 300px;
    }
    button {
      padding: 10px;
      margin: 5px 0;
      cursor: pointer;
    }
    .card {
      background: #1e293b;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      display: flex;
      align-items: center;
    }
    .card img {
      width: 80px;
      margin-right: 10px;
      border-radius: 5px;
    }
  </style>
</head>

<body>

  <button onclick="connectTrakt()">Connect Trakt</button>
  <p id="traktStatus"></p>

  <h1>ðŸŽ¬ My Free Tracker</h1>

  <input id="searchInput" placeholder="Search movies or TV shows">
  <button onclick="search()">Search</button>

  <div id="results"></div>

  <script>
    const TRAKT_CLIENT_ID =
      "ca3904ae972de4cad0c6a3b029fa0e02ad7cd3581d1ebebdfcebaa8cc11d22c7";

    const API_KEY = "fb06f7b1871ea929f9c0e515e3ecfe13";

    let deviceCode = null;
    let pollInterval = null;

    // âœ… Check existing token on load
    document.addEventListener("DOMContentLoaded", () => {
      const existingToken = localStorage.getItem("trakt_token");
      if (existingToken) {
        document.getElementById("traktStatus").innerText =
          "âœ… Connected to Trakt!";
      }
    });

    function connectTrakt() {
      const token = localStorage.getItem("trakt_token");
      if (token) {
        document.getElementById("traktStatus").innerText =
          "âœ… Already connected to Trakt!";
        return;
      }
      startTraktDeviceAuth();
    }

    function startTraktDeviceAuth() {
      fetch("https://api.trakt.tv/oauth/device/code", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "trakt-api-version": "2",
          "trakt-api-key": TRAKT_CLIENT_ID
        },
        body: JSON.stringify({ client_id: TRAKT_CLIENT_ID })
      })
      .then(res => res.json())
      .then(data => {
        deviceCode = data.device_code;

        document.getElementById("traktStatus").innerHTML = `
          <p>Go to:</p>
          <p><strong>${data.verification_url}</strong></p>
          <p>Enter this code:</p>
          <h2>${data.user_code}</h2>
        `;

        pollInterval = setInterval(checkTraktAuth, data.interval * 1000);
      });
    }

    function checkTraktAuth() {
      fetch("https://royal-glitter-3529.whatpalomalikes.workers.dev", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: deviceCode })
      })
      .then(res => res.status === 200 ? res.json() : null)
      .then(data => {
        if (!data || !data.access_token) return;

        clearInterval(pollInterval);
        localStorage.setItem("trakt_token", data.access_token);
        document.getElementById("traktStatus").innerText =
          "âœ… Connected to Trakt!";
      });
    }

    function search() {
      const query = document.getElementById("searchInput").value;
      fetch(`https://api.themoviedb.org/3/search/multi?api_key=${API_KEY}&query=${query}`)
        .then(res => res.json())
        .then(data => showResults(data.results));
    }

    function showResults(items) {
      const results = document.getElementById("results");
      results.innerHTML = "";

      items.forEach(item => {
        if (!item.poster_path) return;

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <img src="https://image.tmdb.org/t/p/w200${item.poster_path}">
          <div>
            <h3>${item.title || item.name}</h3>
            <button onclick="markWatched('${item.id}', '${item.title || item.name}')">
              Mark Watched
            </button>
          </div>
        `;
        results.appendChild(card);
      });
    }

    function markWatched(id, title) {
      let watched = JSON.parse(localStorage.getItem("watched")) || [];
      watched.push({ id, title });
      localStorage.setItem("watched", JSON.stringify(watched));
      alert(`${title} added to watched list`);
    }
  </script>

</body>
</html>
